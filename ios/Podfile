# Explicitly specify CocoaPods source to avoid CDN issues
source 'https://github.com/CocoaPods/Specs.git'

require File.join(File.dirname(`node --print "require.resolve('expo/package.json')"`), "scripts/autolinking")
require File.join(File.dirname(`node --print "require.resolve('react-native/package.json')"`), "scripts/react_native_pods")

require 'json'
podfile_properties = JSON.parse(File.read(File.join(__dir__, 'Podfile.properties.json'))) rescue {}

def ccache_enabled?(podfile_properties)
  # Environment variable takes precedence
  return ENV['USE_CCACHE'] == '1' if ENV['USE_CCACHE']
  
  # Fall back to Podfile properties
  podfile_properties['apple.ccacheEnabled'] == 'true'
end

# ULTIMATE Release/Production build detection for 2025 EAS builds
# This function comprehensively detects all Release/CI/Production scenarios
def is_release_build?
  # Method 1: Explicit build configuration (highest priority)
  build_config = ENV['CONFIGURATION'] || ENV['BUILD_CONFIGURATION'] || podfile_properties['ios.buildConfiguration']
  if build_config == 'Release'
    return true
  end
  
  # Method 2: EAS build profile detection
  if ENV['EAS_BUILD_PROFILE'] == 'production'
    return true
  end
  
  # Method 3: EAS build environment (production builds are always Release)
  if ENV['EAS_BUILD'] == 'true' && ENV['EAS_BUILD_PROFILE'] != 'development'
    return true
  end
  
  # Method 4: CI environment detection (GitHub Actions, GitLab CI, etc.)
  if ENV['CI'] == 'true' || ENV['CONTINUOUS_INTEGRATION'] == 'true'
    # In CI, assume Release unless explicitly Debug
    return build_config != 'Debug'
  end
  
  # Method 5: Check for production-like environment variables
  if ENV['NODE_ENV'] == 'production' || ENV['EXPO_PUBLIC_ENV'] == 'production'
    return true
  end
  
  # Method 6: Check Xcode build settings (for local Release builds)
  if ENV['CONFIGURATION_BUILD_DIR'] && ENV['CONFIGURATION_BUILD_DIR'].include?('Release')
    return true
  end
  
  # Method 7: Default to Release if no Debug configuration is explicitly set
  # This is the safest default for EAS production builds
  if ENV['CONFIGURATION'].nil? && ENV['BUILD_CONFIGURATION'].nil? && podfile_properties['ios.buildConfiguration'].nil?
    # If no explicit configuration, assume Release for safety
    # Debug builds should always explicitly set CONFIGURATION=Debug
    return true
  end
  
  false
end

# SCORCHED EARTH: Check if Flipper should be enabled (ONLY in Debug)
# Multiple layers of protection to ensure Flipper is DEAD in production
def flipper_enabled?
  # Layer 1: Explicit NO_FLIPPER environment variable (highest priority)
  if ENV['NO_FLIPPER'] == '1'
    return false
  end
  
  # Layer 2: Release build detection
  if is_release_build?
    return false
  end
  
  # Layer 3: Production environment
  if ENV['NODE_ENV'] == 'production' || ENV['EAS_BUILD_PROFILE'] == 'production'
    return false
  end
  
  # Only enable Flipper if explicitly in Debug mode
  build_config = ENV['CONFIGURATION'] || ENV['BUILD_CONFIGURATION'] || podfile_properties['ios.buildConfiguration']
  build_config == 'Debug'
end

ENV['RCT_NEW_ARCH_ENABLED'] ||= '0' if podfile_properties['newArchEnabled'] == 'false'
ENV['EX_DEV_CLIENT_NETWORK_INSPECTOR'] ||= podfile_properties['EX_DEV_CLIENT_NETWORK_INSPECTOR']
ENV['RCT_USE_RN_DEP'] ||= '1' if podfile_properties['ios.buildReactNativeFromSource'] != 'true' && podfile_properties['newArchEnabled'] != 'false'
ENV['RCT_USE_PREBUILT_RNCORE'] ||= '1' if podfile_properties['ios.buildReactNativeFromSource'] != 'true' && podfile_properties['newArchEnabled'] != 'false'
platform :ios, podfile_properties['ios.deploymentTarget'] || '15.1'

prepare_react_native_project!

target 'WhisperLine' do
  use_expo_modules!

  if ENV['EXPO_USE_COMMUNITY_AUTOLINKING'] == '1'
    config_command = ['node', '-e', "process.argv=['', '', 'config'];require('@react-native-community/cli').run()"];
  else
    config_command = [
      'npx',
      'expo-modules-autolinking',
      'react-native-config',
      '--json',
      '--platform',
      'ios'
    ]
  end

  config = use_native_modules!(config_command)

  use_frameworks! :linkage => podfile_properties['ios.useFrameworks'].to_sym if podfile_properties['ios.useFrameworks']
  use_frameworks! :linkage => ENV['USE_FRAMEWORKS'].to_sym if ENV['USE_FRAMEWORKS']

  # SCORCHED EARTH: Disable Flipper COMPLETELY in Release/Production builds
  # Flipper is a debug-only tool and should NEVER be included in production builds
  # Multiple layers of protection ensure Flipper is DEAD in production
  
  # CRITICAL: Never call use_flipper!() in production
  # We use flipper_configuration parameter instead, which is safer
  flipper_config = flipper_enabled? ? FlipperConfiguration.enabled : FlipperConfiguration.disabled
  
  # Double-check: If NO_FLIPPER is set, force disable
  if ENV['NO_FLIPPER'] == '1'
    flipper_config = FlipperConfiguration.disabled
    puts "üö´ [Flipper] Explicitly disabled via NO_FLIPPER=1"
  end
  
  use_react_native!(
    :path => config[:reactNativePath],
    :hermes_enabled => podfile_properties['expo.jsEngine'] == nil || podfile_properties['expo.jsEngine'] == 'hermes',
    # An absolute path to your application root.
    :app_path => "#{Pod::Config.instance.installation_root}/..",
    :privacy_file_aggregation_enabled => podfile_properties['apple.privacyManifestAggregationEnabled'] != 'false',
    # Explicitly disable Flipper in Release/Production builds
    :flipper_configuration => flipper_config,
  )
  
  # CRITICAL: Ensure use_flipper!() is NEVER called in Release configuration
  # We use flipper_configuration parameter instead of use_flipper!() to avoid any issues
  # This ensures Flipper is completely disabled in production builds
  if is_release_build? || ENV['NO_FLIPPER'] == '1'
    puts "üö´ [Flipper] Production build detected - use_flipper!() will NEVER be called"
  end

  post_install do |installer|
    # Standard React Native post-install
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false,
      :ccache_enabled => ccache_enabled?(podfile_properties),
    )
    
    # ULTIMATE Release build cleanup for 2025 EAS production builds
    if is_release_build?
      puts "üîß [Release Build] Starting comprehensive debug-only cleanup..."
      
      # Step 1: Remove all debug-only pods
      debug_only_pods = [
        'ReactNativeStaticServer',
        'Flipper',
        'FlipperKit',
        'Flipper-Folly',
        'Flipper-Glog',
        'Flipper-PeerTalk',
        'Flipper-RSocket',
        'CocoaAsyncSocket',
        'FlipperDoubleConversion',
        'FlipperFmt',
        'Flipper-Boost-iOSX',
        'Flipper-DoubleConversion',
        'Flipper-Fmt',
        'Flipper-PeerTalk',
        'Flipper-RSocket',
        'FlipperKit',
        'FlipperKit-Core',
        'FlipperKit-Folly',
        'FlipperKit-Glog',
        'FlipperKit-RSocket',
        'FlipperKit-SKIOSNetworkPlugin',
        'FlipperKitUserDefaultsPlugin',
        'FlipperKitLayoutPlugin',
        'FlipperKitLayoutTextSearchable',
        'FlipperKitNetworkPlugin',
        'FlipperKitReactPlugin',
        'FlipperKitReactNativePlugin',
      ]
      
      removed_pods = []
      installer.pods_project.targets.each do |target|
        should_remove = debug_only_pods.any? { |pod_name| target.name.include?(pod_name) }
        
        if should_remove
          puts "‚ö†Ô∏è  [Release Build] Removing debug-only pod: #{target.name}"
          target.remove_from_project
          removed_pods << target.name
        end
      end
      
      if removed_pods.any?
        puts "‚úÖ [Release Build] Removed #{removed_pods.length} debug-only pod(s): #{removed_pods.join(', ')}"
      end
      
      # Step 2: Remove debug-only architectures and symbols from all targets
      installer.pods_project.targets.each do |target|
        target.build_configurations.each do |config|
          if config.name == 'Release'
            # Remove debug architectures (x86_64 simulator in Release builds)
            config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'arm64 x86_64'
            config.build_settings['ONLY_ACTIVE_ARCH'] = 'NO'
            
            # Strip debug symbols
            config.build_settings['STRIP_INSTALLED_PRODUCT'] = 'YES'
            config.build_settings['COPY_PHASE_STRIP'] = 'YES'
            config.build_settings['STRIP_STYLE'] = 'all'
            
            # Remove debug information
            config.build_settings['DEBUG_INFORMATION_FORMAT'] = 'dwarf'
            config.build_settings['GCC_GENERATE_DEBUGGING_SYMBOLS'] = 'NO'
            
            # Optimize for Release
            config.build_settings['SWIFT_OPTIMIZATION_LEVEL'] = '-O'
            config.build_settings['GCC_OPTIMIZATION_LEVEL'] = 's'
            
            puts "üîß [Release Build] Optimized #{target.name} for Release"
          end
        end
      end
      
      # Step 3: SCORCHED EARTH - Fix IPHONEOS_DEPLOYMENT_TARGET mismatches and signing issues
      # This prevents exit code 65 archive failures
      deployment_target = podfile_properties['ios.deploymentTarget'] || '15.1'
      
      installer.pods_project.targets.each do |target|
        target.build_configurations.each do |config|
          # CRITICAL: Fix IPHONEOS_DEPLOYMENT_TARGET mismatches (prevents signing issues)
          config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = deployment_target
          
          # CRITICAL: Ensure ENABLE_BITCODE is NO (required for modern builds)
          config.build_settings['ENABLE_BITCODE'] = 'NO'
          
          if config.name == 'Release'
            # Xcode 16.1+ requires explicit script phase handling
            config.build_settings['ENABLE_TESTABILITY'] = 'NO'
            
            # Xcode 16.1+ compatibility settings
            config.build_settings['SWIFT_VERSION'] = '5.0'
            
            # Disable warnings that can cause archive failures
            config.build_settings['GCC_WARN_INHIBIT_ALL_WARNINGS'] = 'YES'
            config.build_settings['CLANG_WARN_QUOTED_INCLUDE_IN_FRAMEWORK_HEADER'] = 'NO'
            
            puts "üîß [Release Build] Fixed IPHONEOS_DEPLOYMENT_TARGET=#{deployment_target} for #{target.name}"
          end
        end
      end
      
      # Step 4: Ensure ALL targets have consistent deployment target (prevents mismatches)
      installer.pods_project.build_configurations.each do |config|
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = deployment_target
      end
      
      puts "‚úÖ [Release Build] Release build optimization complete!"
      puts "   - Removed #{removed_pods.length} debug-only pod(s)"
      puts "   - Cleaned debug architectures and symbols"
      puts "   - Applied Xcode 16.1+ compatibility settings"
    else
      puts "‚ÑπÔ∏è  [Debug Build] Debug-only pods enabled (Flipper, ReactNativeStaticServer, etc.)"
    end
    
    # Additional Xcode 16.1+ compatibility for all builds
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        # Fix for Xcode 16.1+ "Invalid Podfile" warnings
        config.build_settings['CLANG_WARN_QUOTED_INCLUDE_IN_FRAMEWORK_HEADER'] = 'NO'
        config.build_settings['CLANG_WARN_DOCUMENTATION_COMMENTS'] = 'NO'
        
        # Ensure proper module map handling
        if config.build_settings['DEFINES_MODULE'] == 'YES'
          config.build_settings['SWIFT_INCLUDE_PATHS'] ||= []
        end
      end
    end
  end
end
