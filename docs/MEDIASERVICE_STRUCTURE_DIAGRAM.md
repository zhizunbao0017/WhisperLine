# MediaService æ¨¡å—ç»“æ„å›¾ï¼ˆç®€åŒ–ç‰ˆï¼‰

## ğŸ¯ æ ¸å¿ƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MediaService                              â”‚
â”‚              (services/MediaService.js)                     â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  å­˜å‚¨è·¯å¾„                                           â”‚    â”‚
â”‚  â”‚  â€¢ companions/ â†’ ${docDir}media/companions/       â”‚    â”‚
â”‚  â”‚  â€¢ entries/    â†’ ${docDir}media/entries/          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ä¾èµ–åº“                                             â”‚    â”‚
â”‚  â”‚  â€¢ expo-file-system                                â”‚    â”‚
â”‚  â”‚  â€¢ expo-image-picker                               â”‚    â”‚
â”‚  â”‚  â€¢ react-native (Platform, Alert, Linking)        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ æä¾› API
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Screens    â”‚   â”‚  Contexts    â”‚   â”‚  Services    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚                 â”‚
        â”‚                 â”‚                 â”‚
        â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ManageCompan â”‚   â”‚ UserState    â”‚   â”‚ Import       â”‚
â”‚ ionsScreen   â”‚   â”‚ Context      â”‚   â”‚ Service      â”‚
â”‚              â”‚   â”‚              â”‚   â”‚              â”‚
â”‚ assignCompan â”‚   â”‚ deleteCompan â”‚   â”‚ importExtern â”‚
â”‚ ionImage()   â”‚   â”‚ ion()        â”‚   â”‚ alImage()    â”‚
â”‚              â”‚   â”‚              â”‚   â”‚              â”‚
â”‚ deleteMedia  â”‚   â”‚ deleteMedia  â”‚   â”‚              â”‚
â”‚ Asset()      â”‚   â”‚ Asset()      â”‚   â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Onboarding   â”‚
â”‚ Screen       â”‚
â”‚              â”‚
â”‚ assignCompan â”‚
â”‚ ionImage()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ–¹æ³•è°ƒç”¨å…³ç³»

### å…¬å¼€ API

```
MediaService
â”‚
â”œâ”€â”€ initialize()
â”‚   â””â”€â”€ ç¡®ä¿å­˜å‚¨ç›®å½•å­˜åœ¨ï¼ˆåº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ï¼‰
â”‚
â”œâ”€â”€ assignCompanionImage(companionId, sourceUri, currentCompanion)
â”‚   â”œâ”€â”€ è°ƒç”¨è€…: ManageCompanionsScreen, OnboardingScreen
â”‚   â”œâ”€â”€ åŠŸèƒ½: è®¾ç½®/æ›´æ–° Companion å¤´åƒ
â”‚   â””â”€â”€ æµç¨‹:
â”‚       â”œâ”€â”€ è¯·æ±‚æƒé™ (_requestMediaLibraryPermission)
â”‚       â”œâ”€â”€ é€‰æ‹©å›¾ç‰‡ (ImagePicker.launchImageLibraryAsync)
â”‚       â”œâ”€â”€ å¤åˆ¶å›¾ç‰‡ (_copyAndStoreImage)
â”‚       â””â”€â”€ è¿”å› updatedCompanion å¯¹è±¡
â”‚
â”œâ”€â”€ importExternalImage(sourcePath, ownerType, ownerId)
â”‚   â”œâ”€â”€ è°ƒç”¨è€…: ImportService
â”‚   â”œâ”€â”€ åŠŸèƒ½: å¯¼å…¥å¤–éƒ¨å›¾ç‰‡ï¼ˆæ•°æ®å¯¼å…¥ï¼‰
â”‚   â””â”€â”€ æµç¨‹:
â”‚       â”œâ”€â”€ éªŒè¯æºæ–‡ä»¶
â”‚       â”œâ”€â”€ å¤åˆ¶å›¾ç‰‡ (_copyAndStoreImage)
â”‚       â””â”€â”€ è¿”å› MediaAsset å¯¹è±¡
â”‚
â”œâ”€â”€ deleteMediaAsset(localPath)
â”‚   â”œâ”€â”€ è°ƒç”¨è€…: ManageCompanionsScreen, UserStateContext
â”‚   â”œâ”€â”€ åŠŸèƒ½: åˆ é™¤åª’ä½“æ–‡ä»¶
â”‚   â””â”€â”€ æµç¨‹:
â”‚       â””â”€â”€ FileSystem.deleteAsync (idempotent: true)
â”‚
â””â”€â”€ getMediaAssetInfo(localPath) [å·²å¼ƒç”¨]
    â””â”€â”€ åŠŸèƒ½: è·å–æ–‡ä»¶ä¿¡æ¯ï¼ˆå¾ˆå°‘ä½¿ç”¨ï¼‰
```

---

## ğŸ”„ æ•°æ®æµå›¾

### åœºæ™¯ 1: è®¾ç½® Companion å¤´åƒ

```
ç”¨æˆ·æ“ä½œ
  â”‚
  â–¼
[ManageCompanionsScreen]
  â”‚ handleAvatarChange(companionId)
  â”‚
  â–¼
[MediaService.assignCompanionImage()]
  â”‚
  â”œâ”€â†’ è¯·æ±‚æƒé™
  â”œâ”€â†’ é€‰æ‹©å›¾ç‰‡
  â”œâ”€â†’ å¤åˆ¶åˆ°æ°¸ä¹…å­˜å‚¨
  â”‚   â””â”€â†’ file:///.../media/companions/{id}_{ts}_{rand}.jpg
  â”‚
  â””â”€â†’ è¿”å› updatedCompanion
      â”‚
      â–¼
[UserStateContext.updateCompanion()]
      â”‚
      â–¼
[UI è‡ªåŠ¨æ›´æ–°]
```

### åœºæ™¯ 2: å¯¼å…¥ Day One æ—¥è®°

```
ç”¨æˆ·æ“ä½œ
  â”‚
  â–¼
[ImportService.startImport()]
  â”‚
  â”œâ”€â†’ è§£æ JSON
  â”œâ”€â†’ æå–ç…§ç‰‡å…ƒæ•°æ®
  â”‚
  â””â”€â†’ éå†ç…§ç‰‡
      â”‚
      â–¼
[MediaService.importExternalImage()]
      â”‚
      â”œâ”€â†’ æ„å»ºæºè·¯å¾„
      â”œâ”€â†’ å¤åˆ¶åˆ°æ°¸ä¹…å­˜å‚¨
      â”‚   â””â”€â†’ file:///.../media/entries/{id}_{ts}_{rand}.jpg
      â”‚
      â””â”€â†’ è¿”å› MediaAsset
          â”‚
          â–¼
[DiaryContext.addDiary()]
          â”‚
          â””â”€â†’ media: [MediaAsset, ...]
```

### åœºæ™¯ 3: åˆ é™¤ Companion

```
ç”¨æˆ·æ“ä½œ
  â”‚
  â–¼
[ManageCompanionsScreen]
  â”‚ handleDelete(companionId)
  â”‚
  â–¼
[UserStateContext.deleteCompanion()]
  â”‚
  â”œâ”€â†’ è·å– avatar è·¯å¾„
  â”‚
  â””â”€â†’ [MediaService.deleteMediaAsset()]
      â”‚
      â””â”€â†’ åˆ é™¤æ–‡ä»¶ï¼ˆå¼‚æ­¥ï¼Œä¸å½±å“åˆ é™¤æµç¨‹ï¼‰
          â”‚
          â–¼
[æ›´æ–°çŠ¶æ€ï¼Œç§»é™¤ Companion]
```

---

## ğŸ—‚ï¸ æ–‡ä»¶å­˜å‚¨ç»“æ„

```
${FileSystem.documentDirectory}/
â””â”€â”€ media/
    â”‚
    â”œâ”€â”€ companions/
    â”‚   â”œâ”€â”€ companion1_1234567890_abc123.jpg
    â”‚   â”œâ”€â”€ companion2_1234567891_def456.png
    â”‚   â””â”€â”€ ...
    â”‚
    â””â”€â”€ entries/
        â”œâ”€â”€ entry1_1234567892_ghi789.jpg
        â”œâ”€â”€ entry2_1234567893_jkl012.png
        â””â”€â”€ ...
```

**å‘½åè§„åˆ™**: `{ownerId}_{timestamp}_{randomId}{extension}`

---

## ğŸ” æƒé™å¤„ç†æµç¨‹

```
assignCompanionImage()
  â”‚
  â–¼
_requestMediaLibraryPermission()
  â”‚
  â”œâ”€â†’ æ£€æŸ¥æƒé™çŠ¶æ€
  â”‚
  â”œâ”€â†’ 'granted' / 'limited' â†’ âœ… ç»§ç»­
  â”‚
  â”œâ”€â†’ 'denied' â†’ âš ï¸ æ˜¾ç¤ºæç¤ºï¼Œå¼•å¯¼åˆ°è®¾ç½®
  â”‚
  â””â”€â†’ 'undetermined' â†’ ğŸ“ è¯·æ±‚æƒé™
```

---

## ğŸ“‹ å…³é”®æ–¹æ³•è¯´æ˜

| æ–¹æ³• | è°ƒç”¨è€… | ç”¨é€” | è¿”å›å€¼ |
|------|--------|------|--------|
| `assignCompanionImage()` | ManageCompanionsScreen<br>OnboardingScreen | è®¾ç½® Companion å¤´åƒ | `Companion` å¯¹è±¡ |
| `importExternalImage()` | ImportService | å¯¼å…¥å¤–éƒ¨å›¾ç‰‡ | `MediaAsset` å¯¹è±¡ |
| `deleteMediaAsset()` | ManageCompanionsScreen<br>UserStateContext | åˆ é™¤åª’ä½“æ–‡ä»¶ | `void` |
| `initialize()` | App å¯åŠ¨æ—¶ | åˆå§‹åŒ–å­˜å‚¨ç›®å½• | `void` |

---

## ğŸ¨ è®¾è®¡æ¨¡å¼

1. **å•ä¾‹æ¨¡å¼**: MediaService æ˜¯é™æ€ç±»ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½æ˜¯é™æ€æ–¹æ³•
2. **å·¥å‚æ¨¡å¼**: `assignCompanionImage()` æ ¹æ®å‚æ•°é€‰æ‹©ä¸åŒçš„å¤„ç†æµç¨‹
3. **ç­–ç•¥æ¨¡å¼**: `_copyAndStoreImage()` æ ¹æ® `ownerType` é€‰æ‹©ä¸åŒçš„å­˜å‚¨ç›®å½•
4. **è´£ä»»é“¾æ¨¡å¼**: æƒé™è¯·æ±‚ â†’ å›¾ç‰‡é€‰æ‹© â†’ æ–‡ä»¶å¤åˆ¶ â†’ è¿”å›ç»“æœ

---

## ğŸ” è°ƒè¯•æ£€æŸ¥æ¸…å•

- [ ] `MediaService.initialize()` æ˜¯å¦åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ï¼Ÿ
- [ ] `app.json` ä¸­æ˜¯å¦é…ç½®äº†å›¾ç‰‡æƒé™ï¼Ÿ
- [ ] å­˜å‚¨ç›®å½•æ˜¯å¦æ­£ç¡®åˆ›å»ºï¼Ÿ
- [ ] æ–‡ä»¶è·¯å¾„æ˜¯å¦åŒ…å«ä¸´æ—¶è·¯å¾„æ ‡è¯†ï¼Ÿ
- [ ] æƒé™è¯·æ±‚æ˜¯å¦æˆåŠŸï¼Ÿ
- [ ] `MediaAsset` å¯¹è±¡çš„ `uri` æ˜¯å¦æ­£ç¡®ï¼Ÿ

---

**å®Œæ•´æ–‡æ¡£**: å‚è§ `docs/MEDIASERVICE_ARCHITECTURE.md`

